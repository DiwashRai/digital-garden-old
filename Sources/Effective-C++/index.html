<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Author: Scott Meyers
Topics: Software Engineering
 Ch1: Accustoming yourself to C++ Item 1: View C++ as a federation of languages C++ is better understood as a group of related sub-languages."><title>Effective C++</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://diwashrai.github.io/digital-garden//icon.png><link href=https://diwashrai.github.io/digital-garden/styles.547fb332ce56cdc523146ba5ede80d7f.min.css rel=stylesheet><link href=https://diwashrai.github.io/digital-garden/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://diwashrai.github.io/digital-garden/js/darkmode.e7521685fecdfbca6dd54d07ef93b61b.min.js></script>
<script src=https://diwashrai.github.io/digital-garden/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script async src=https://diwashrai.github.io/digital-garden/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://diwashrai.github.io/digital-garden/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://diwashrai.github.io/digital-garden/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://diwashrai.github.io/digital-garden/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://diwashrai.github.io/digital-garden/",fetchData=Promise.all([fetch("https://diwashrai.github.io/digital-garden/indices/linkIndex.794229e4be2d39f1abf38f2f46f56d67.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://diwashrai.github.io/digital-garden/indices/contentIndex.849667d23a75b00046f953b4069c72f4.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://diwashrai.github.io/digital-garden",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://diwashrai.github.io/digital-garden",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/diwashrai.github.io\/digital-garden\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=diwashrai.github.io/digital-garden src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://diwashrai.github.io/digital-garden/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://diwashrai.github.io/digital-garden/>Diwash's Digital Garden ðŸŒ±</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Effective C++</h1><p class=meta>Last updated
Mar 5, 2023
<a href=https://github.com/DiwashRai/digital-garden/tree/main/content/Sources/Effective%20C++.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://diwashrai.github.io/digital-garden/tags/source/>Source</a></li><li><a href=https://diwashrai.github.io/digital-garden/tags/textbook/>Textbook</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#ch1-accustoming-yourself-to-c>Ch1: Accustoming yourself to C++</a><ol><li><a href=#item-1-view-c-as-a-federation-of-languages><strong>Item 1:</strong> View C++ as a federation of languages</a></li><li><a href=#item-2-prefer-consts-enums-and-inlines-to-defines><strong>Item 2:</strong> Prefer consts, enums, and inlines to #defines</a></li><li><a href=#item-3-use-const-whenever-possible><strong>Item 3:</strong> Use const whenever possible</a></li><li><a href=#item-4-make-sure-objects-are-initialised-before-use><strong>Item 4:</strong> Make sure objects are initialised before use</a></li></ol></li><li><a href=#ch2-constructors-destructors-and-assignment-operators>Ch2: Constructors, destructors and assignment operators</a><ol><li><a href=#item-5-know-what-functions-c-silently-writes-and-calls><strong>Item 5:</strong> Know what functions C++ silently writes and calls</a></li><li><a href=#item-6-explicitly-disallow-the-use-of-compiler-generated-functions-you-do-not-want><strong>Item 6:</strong> Explicitly disallow the use of compiler-generated functions you do not want</a></li><li><a href=#item-7-declare-destructors-virtual-in-polymorphic-base-classes><strong>Item 7:</strong> Declare destructors virtual in polymorphic base classes</a></li><li><a href=#item-8-prevent-exceptions-from-leaving-destructors><strong>Item 8:</strong> Prevent exceptions from leaving destructors</a></li><li><a href=#item-9-never-call-virtual-functions-during-construction-or-destruction><strong>Item 9:</strong> Never call virtual functions during construction or destruction</a></li><li><a href=#item-10-have-assignment-operators-return-a-reference-to-this><strong>Item 10:</strong> Have assignment operators return a reference to <code>this</code></a></li><li><a href=#item-11-handle-assignment-to-self-in-operator><strong>Item 11:</strong> Handle assignment to self in operator=.</a></li><li><a href=#item-12-copy-all-parts-of-an-object><strong>Item 12:</strong> Copy all parts of an object.</a></li></ol></li><li><a href=#ch3-resource-management>Ch3: Resource management</a><ol><li><a href=#item-13-use-objects-to-manage-resources><strong>Item 13:</strong> Use objects to manage resources</a></li><li><a href=#item-14-think-carefully-about-copying-behaviour-in-resource-managing-classes><strong>Item 14:</strong> Think carefully about copying behaviour in resource-managing classes</a></li><li><a href=#item-15-provide-access-to-raw-resources-in-resource-managing-classes><strong>Item 15:</strong> Provide access to raw resources in resource-managing classes</a></li><li><a href=#item-16-use-the-same-form-in-corresponding-uses-of-new-and-delete><strong>Item 16:</strong> Use the same form in corresponding uses of <code>new</code> and <code>delete</code></a></li><li><a href=#item-17-store-newed-objects-in-smart-pointers-in-standalone-statements><strong>Item 17:</strong> Store newed objects in smart pointers in standalone statements</a></li></ol></li><li><a href=#ch4-designs-and-declarations>Ch4: Designs and declarations</a><ol><li><a href=#item-18-make-interfaces-easy-to-use-correctly-and-hard-to-use-incorrectly><strong>Item 18:</strong> Make interfaces easy to use correctly and hard to use incorrectly.</a></li><li><a href=#item-19-treat-class-design-as-type-design><strong>Item 19:</strong> Treat class design as type design.</a></li><li><a href=#item-20-prefer-pass-by-reference-to-const-to-pass-by-value><strong>Item 20:</strong> Prefer pass-by-reference-to-const to pass-by-value.</a></li><li><a href=#item-21-dont-try-to-return-a-reference-when-you-must-return-an-object><strong>Item 21:</strong> Don&rsquo;t try to return a reference when you must return an object.</a></li><li><a href=#item-22-declare-data-members-private><strong>Item 22:</strong> Declare data members private.</a></li><li><a href=#item-23-prefer-non-member-non-friend-functions-to-member-functions><strong>Item 23:</strong> Prefer non-member non-friend functions to member functions.</a></li><li><a href=#item-24-declare-non-member-functions-when-type-conversions-should-apply-to-all-parameters><strong>Item 24:</strong> Declare non-member functions when type conversions should apply to all parameters.</a></li><li><a href=#item-25-consider-support-for-a-non-throwing-swap><strong>Item 25:</strong> Consider support for a non-throwing swap.</a></li></ol></li><li><a href=#ch5-implementations>Ch5: Implementations</a></li><li><a href=#ch6-inheritance-and-object-oriented-design>Ch6: Inheritance and Object-Oriented Design</a></li><li><a href=#ch7-templates-and-generic-programming>Ch7: Templates and generic programming</a></li><li><a href=#ch8-customising-new-and-delete>Ch8: Customising <code>new</code> and <code>delete</code></a></li><li><a href=#ch9-miscellany>Ch9: Miscellany</a></li></ol></nav></details></aside><p>Author:
<a href=/digital-garden/Authors/Scott-Meyers/ rel=noopener class=internal-link data-src=/digital-garden/Authors/Scott-Meyers/>Scott Meyers</a><br>Topics:
<a href=/digital-garden/Topics/Software-Engineering/ rel=noopener class=internal-link data-src=/digital-garden/Topics/Software-Engineering/>Software Engineering</a></p><hr><a href=#ch1-accustoming-yourself-to-c><h2 id=ch1-accustoming-yourself-to-c><span class=hanchor arialabel=Anchor># </span>Ch1: Accustoming yourself to C++</h2></a><a href=#item-1-view-c-as-a-federation-of-languages><h3 id=item-1-view-c-as-a-federation-of-languages><span class=hanchor arialabel=Anchor># </span><strong>Item 1:</strong> View C++ as a federation of languages</h3></a><p>C++ is better understood as a group of related sub-languages. These are:</p><ul><li>C</li><li>Object-oriented C++</li><li>Template C++</li><li>The STL</li></ul><p>This is important to keep in mind as different sublanguages have different effective strategies and different conventions.</p><a href=#item-2-prefer-consts-enums-and-inlines-to-defines><h3 id=item-2-prefer-consts-enums-and-inlines-to-defines><span class=hanchor arialabel=Anchor># </span><strong>Item 2:</strong> Prefer consts, enums, and inlines to #defines</h3></a><p>Rule could also be called &ldquo;Prefer the compiler over the preprocessor&rdquo;.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// BAD
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define ASPECT_RATIO 1.653
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// GOOD
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=kt>double</span> <span class=n>AspectRation</span> <span class=o>=</span> <span class=mf>1.653</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=k>const</span> <span class=n>authorName</span> <span class=o>=</span> <span class=s>&#34;Scott Meyers&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>authorName</span><span class=p>(</span><span class=s>&#34;Scott Meyers&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>The preprocessor will blindly subsitute ASPECT_RATIO for 1.653 resulting in multple copies in the object code.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// BAD
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define CALL_WITH_MAX(a,b) f((a) &gt; (b) ? (a) : (b))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// GOOD
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=n>callWithMax</span><span class=p>(</span><span class=k>const</span> <span class=n>T</span><span class=o>&amp;</span> <span class=n>a</span><span class=p>,</span> <span class=k>const</span> <span class=n>T</span><span class=o>&amp;</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=p>(</span><span class=n>a</span> <span class=o>&gt;</span> <span class=n>b</span> <span class=o>?</span> <span class=nl>a</span><span class=p>:</span> <span class=n>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Function like macros can be very error prone. Calling <code>CALL_WITH_MAX(++a, b)</code> for example results in a being incremented twice.</p><a href=#item-3-use-const-whenever-possible><h3 id=item-3-use-const-whenever-possible><span class=hanchor arialabel=Anchor># </span><strong>Item 3:</strong> Use const whenever possible</h3></a><ul><li>Helps detect usage errors.</li><li>Using <code>const</code> in function declaration is extremely powerful so make use of it. It can refer to the function&rsquo;s return value, the individual parameters or even the function as a whole.</li><li>Compilers enforce &lsquo;bitwise constness&rsquo; but you should program using &rsquo;logical constness&rsquo;.<ul><li>Bitwise constness/Physical: does not modify any of object&rsquo;s data members</li><li>Logical constness: Some data members of an object can be modified but should be in ways the client cannot detect. Achieved using <code>mutable</code>. Also considers situations where something is bitwise const, but does not behave const. e.g. the altering of data members by returning non-const references.</li></ul></li><li>When const and non-const member functions have similar implementations, avoid duplication by calling const version in the non-const function and using <code>const_cast</code>.</li></ul><a href=#item-4-make-sure-objects-are-initialised-before-use><h3 id=item-4-make-sure-objects-are-initialised-before-use><span class=hanchor arialabel=Anchor># </span><strong>Item 4:</strong> Make sure objects are initialised before use</h3></a><p>The rules about when objects initialisation is guaranteed or not is too complicated to be worth memorising. Avoid the issue by <mark>always initialising</mark>.</p><ul><li>For non-member built in types, this needs to be done manually. e.g. <code>int x = 0;</code></li><li>For the rest, initialisation is the responsibility of the constructors and the use of initialisation list is preferred.</li></ul><a href=#ch2-constructors-destructors-and-assignment-operators><h2 id=ch2-constructors-destructors-and-assignment-operators><span class=hanchor arialabel=Anchor># </span>Ch2: Constructors, destructors and assignment operators</h2></a><a href=#item-5-know-what-functions-c-silently-writes-and-calls><h3 id=item-5-know-what-functions-c-silently-writes-and-calls><span class=hanchor arialabel=Anchor># </span><strong>Item 5:</strong> Know what functions C++ silently writes and calls</h3></a><p>Compilers will declare the following if you do not do so yourself:</p><ul><li>Copy constructor</li><li>Copy assignment operator</li><li>Destructor</li></ul><p>If no constructors are declared at all, compilers will also declare:</p><ul><li>Default constructor</li></ul><a href=#item-6-explicitly-disallow-the-use-of-compiler-generated-functions-you-do-not-want><h3 id=item-6-explicitly-disallow-the-use-of-compiler-generated-functions-you-do-not-want><span class=hanchor arialabel=Anchor># </span><strong>Item 6:</strong> Explicitly disallow the use of compiler-generated functions you do not want</h3></a><p>An example of an unwanted generated function is a copy constructor and copy assignment operator for objects that should not be copied.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>HomeForSale</span> <span class=n>h1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>HomeForSale</span> <span class=n>h2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>HomeForSale</span> <span class=nf>h3</span><span class=p>(</span><span class=n>h1</span><span class=p>);</span> <span class=c1>//should not compile
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>h1</span> <span class=o>=</span> <span class=n>h2</span><span class=p>;</span>            <span class=c1>// should not compile
</span></span></span></code></pre></td></tr></table></div></div><p>To achieve this there is a <mark>well known trick</mark>. Declare the functions private and do not implement them.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>HomeForSale</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>HomeForSale</span><span class=p>(</span><span class=k>const</span> <span class=n>HomeForSale</span><span class=o>&amp;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>HomeForSale</span><span class=o>&amp;</span> <span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=n>ocnst</span> <span class=n>HomeForSale</span><span class=o>&amp;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This trick works and generates a link-time error. It is possible to move
it up to a compile time error by declaring the functions private in a base
class designed just to prevent copying.</p><blockquote class=abstract-callout><p>Summary</p><ul><li>Disallow compiler generated function by declaring the function private and not providing an implementation</li></ul></blockquote><a href=#item-7-declare-destructors-virtual-in-polymorphic-base-classes><h3 id=item-7-declare-destructors-virtual-in-polymorphic-base-classes><span class=hanchor arialabel=Anchor># </span><strong>Item 7:</strong> Declare destructors virtual in polymorphic base classes</h3></a><p>Lets say you have a base class <code>TimeKeeper</code> and some derivided classes
that inherit from it:</p><ul><li>AtomicClock</li><li>WaterClock</li><li>WristWatch</li></ul><p>If you try to delete a derived class (e.g. WristWatch) with a base class
pointer (TimeKeeper), the results are undefined. Most likely, the derived
class parts of the object won&rsquo;t be deleted. This is a good way to leak
memory.</p><p>Solution is simple: <mark>give the base class a virtual destructor</mark>.</p><p>However, when a class is not meant to be used as a base class, making it
virtual is usually a bad idea. This is because virtual functions require the
use of vptr (&ldquo;virtual table pointers&rdquo;) which increases the size of the type.
A simple data type that contains two ints, would go from 64bits in size to
128bits. An increase of 100%. It also makes the object less portable to C.</p><p>If you want to make a class abstract that does not have functions to make
virtual, you can just give it a pure virtual destructor. This is because a
abstract classes are meant to be base classes and base classes should
have a virtual destructor.</p><blockquote class=abstract-callout><p>Summary</p><ul><li>Polymorphic base classes should declare virtual destructors.</li><li>Any class with virtual functions should have a virtual destructor.</li><li>Classes that aren&rsquo;t base classes should not declare virtual destructors.</li><li>Use a pure virtual destructor to make classes abstract that do not have functions</li></ul></blockquote><a href=#item-8-prevent-exceptions-from-leaving-destructors><h3 id=item-8-prevent-exceptions-from-leaving-destructors><span class=hanchor arialabel=Anchor># </span><strong>Item 8:</strong> Prevent exceptions from leaving destructors</h3></a><p>C++ allows destructors to emit exceptions but it is heavily discouraged.
This is because if an exception is thrown, for example, in a vector
containing 10 widgets, the rest of the widgets still need to be deleted or
there will be leak. However, if you then have another exception when
deleting the other widgets, now you have two simultaneous exceptions
which results in undefined behaviour.</p><p>Example class that closes database connection in destructor:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>DBConn</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>DBConn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>.</span><span class=n>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>DBConnection</span> <span class=n>db</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This will cause issues if the call to close results in an exception. The
exception will be propagated.</p><p>There are two options to fix this:</p><ul><li><mark>Terminate the program</mark> (e.g. with std::abort()). This is a reasonable solution if the program can no longer run due to the error.</li><li><mark>Swallow the exception</mark>. This is a bad idea as we need to know when something fails.</li></ul><p>The actual ideal solution is to create a function that closes the connection
in the DBConn interface so the client can react to the exception. Then
the backup call to &lsquo;close()&rsquo; can still be placed in the destructor. This may
seem like it goes against <em>item 11</em>, by placing an extra burden on the client,
however it is not as it actually <strong>gives</strong> them a chance to react to the
exception.</p><blockquote class=abstract-callout><p>Summary</p><ul><li>Destructors should never emit exceptions.</li><li>If a classes clients need to react to exceptions during an operation, offer a regular &rsquo;non-destrcutor&rsquo; function that performs the operation.</li></ul></blockquote><a href=#item-9-never-call-virtual-functions-during-construction-or-destruction><h3 id=item-9-never-call-virtual-functions-during-construction-or-destruction><span class=hanchor arialabel=Anchor># </span><strong>Item 9:</strong> Never call virtual functions during construction or destruction</h3></a><p>Don&rsquo;t call virtual functions during construction or destruction as they won&rsquo;t
do what you expect them to. If they did, it would lead to undefined
behaviour.</p><p>Example: Say you have a base class <code>Transaction</code> that is inherited by a
class called <code>BuyTransaction</code>. If you have a virtual function in Transaction
that is called during construction, it will call the base class version. Not
the derived version. This is because the base class is constructed first so
the derived members will not have been constructed yet.</p><blockquote class=abstract-callout><p>Summary</p><ul><li>Don&rsquo;t call virtual functions from constructors or destructors.</li></ul></blockquote><a href=#item-10-have-assignment-operators-return-a-reference-to-this><h3 id=item-10-have-assignment-operators-return-a-reference-to-this><span class=hanchor arialabel=Anchor># </span><strong>Item 10:</strong> Have assignment operators return a reference to <code>this</code></h3></a><p>Assignments can be chained together and is right associative.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>y</span> <span class=o>=</span> <span class=n>z</span> <span class=o>=</span> <span class=mi>15</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//equivalent to
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>z</span> <span class=o>=</span> <span class=mi>15</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>This is implemented by assignments returning a reference to it&rsquo;s left hand argument. This is the convention that should be followed.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Widget</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=n>Widget</span><span class=o>&amp;</span> <span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>Widget</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote class=abstract-callout><p>Summary</p><ul><li>Have assignment operators return a reference to <code>*this</code></li></ul></blockquote><a href=#item-11-handle-assignment-to-self-in-operator><h3 id=item-11-handle-assignment-to-self-in-operator><span class=hanchor arialabel=Anchor># </span><strong>Item 11:</strong> Handle assignment to self in operator=.</h3></a><p>This looks silly but is allowed:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Widget</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>w</span> <span class=o>=</span> <span class=n>w</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>``
If it&rsquo;s allowed, clients will end up doing it. A less obvious version may look
like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// potential assignment to selfs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=o>*</span><span class=n>px</span> <span class=o>=</span> <span class=o>*</span><span class=n>py</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>When writing resource managing classes you can fall into the trap of
accidentally releasing a resource before you&rsquo;re done with it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Bitmap</span> <span class=p>{...};</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Widget</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Bitmap</span> <span class=o>*</span><span class=n>pb</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Widget</span><span class=o>&amp;</span> <span class=n>Widget</span><span class=o>::</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>Widget</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=n>pb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pb</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bitmap</span><span class=p>(</span><span class=o>*</span><span class=n>rhs</span><span class=p>.</span><span class=n>pb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Here you delete rhs not realising that it is the same as <code>this</code>. The
traditional fix is this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Widget</span><span class=o>&amp;</span> <span class=n>Widget</span><span class=o>::</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>Widget</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>rhs</span><span class=p>)</span> <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=n>pb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pb</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bitmap</span><span class=p>(</span><span class=o>*</span><span class=n>rhs</span><span class=p>.</span><span class=n>pb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This is now self-assignment safe but not exception safe. If <code>new Bitmap</code>
causes an exception, it will still cause issues.</p><p>Making operator= exception-safe also typically also renders it
self-assignment-safe. It is common to deal with self-assignment issues by
ignoring them and isntead focusing on exception safety. A careful ordering
of statements can make code exception safe. For example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Widget</span><span class=o>&amp;</span> <span class=n>Widget</span><span class=o>::</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>Widget</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Bitmap</span> <span class=o>*</span><span class=n>pOrig</span> <span class=o>=</span> <span class=n>pb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pb</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bitmap</span><span class=p>(</span><span class=o>*</span><span class=n>rhs</span><span class=p>.</span><span class=n>pb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=n>pOrig</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote class=tip-callout><p>Performance Hint</p><p>The identity test can still be placed at the top for efficiency, however,
consider how often self-assignment occurs. The check is not free. It
makes the source code and object bigger and introduces a branch.</p></blockquote><p>Alternative to manual ordering is the &ldquo;copy and swap&rdquo; technique.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Widget</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=n>swap</span><span class=p>(</span><span class=n>Widget</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>);</span> <span class=c1>// exchanges *this and rhs&#39;s data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Widget</span><span class=o>&amp;</span> <span class=n>Widget</span><span class=o>::</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>Widget</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Widget</span> <span class=nf>temp</span><span class=p>(</span><span class=n>rhs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>swap</span><span class=p>(</span><span class=n>temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The final variation sacrifices some clarity for allowing the compiler to
sometimes generate more efficient code.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Widget</span><span class=o>&amp;</span> <span class=n>Widget</span><span class=o>::</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=n>Widget</span> <span class=n>rhs</span><span class=p>)</span> <span class=c1>// rhs is a copy of the object
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>swap</span><span class=p>(</span><span class=n>rhs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote class=abstract-callout><p>Summary</p><ul><li>Make sure operator= can handle self-assignment in a well-behaved
manner</li><li>Make sure any function operating on more than one object behaves
well if two or more of the objects are the same.</li></ul></blockquote><a href=#item-12-copy-all-parts-of-an-object><h3 id=item-12-copy-all-parts-of-an-object><span class=hanchor arialabel=Anchor># </span><strong>Item 12:</strong> Copy all parts of an object.</h3></a><p>Well-designed objects contain only two functions that copy objects: the
copy constructor and copy assignment operator. Compilers will generate
these functions if required and do what you expect them to: copy all the
data of the object being copied.</p><p>However, when you declare your own copy functions, they do not warn you
when your implementation is wrong. You may forget to copy a newly
added data member and there will be no warnings.</p><p>Another way that you may run into issues is when using inheritance.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>PriorityCustomer</span><span class=o>:</span><span class=k>public</span> <span class=n>Customer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=n>PriorityCustomer</span><span class=p>(</span><span class=k>const</span> <span class=n>PriorityCustomer</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>PriorityCustomer</span><span class=o>&amp;</span> <span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>PriorityCustomer</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>priority</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PriorityCustomer</span><span class=o>::</span><span class=n>PriorityCustomer</span><span class=p>(</span><span class=k>const</span> <span class=n>PriorityCustomer</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>:</span> <span class=n>priority</span><span class=p>(</span><span class=n>rhs</span><span class=p>.</span><span class=n>priority</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logCall</span><span class=p>(</span><span class=s>&#34;PriorityCustomer copy constructor&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PriorityCustomer</span><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=n>PriorityCustomer</span><span class=o>::</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>PriorityCustomer</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logCall</span><span class=p>(</span><span class=s>&#34;PriorityCustomer copy assignment operator&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>priority</span> <span class=o>=</span> <span class=n>rhs</span><span class=p>.</span><span class=n>priority</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This may look fine and appear to be copying everything, however,
crucially, they are not copying the data members it inherits from customer.
The fix to this would be the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PriorityCustomer</span><span class=o>::</span><span class=n>PriorityCustomer</span><span class=p>(</span><span class=k>const</span> <span class=n>PriorityCustomer</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>:</span> <span class=n>Customer</span><span class=p>(</span><span class=n>rhs</span><span class=p>)</span>                 <span class=c1>// invoke base class copy ctor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>priority</span><span class=p>(</span><span class=n>rhs</span><span class=p>.</span><span class=n>priority</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logCall</span><span class=p>(</span><span class=s>&#34;PriorityCustomer copy constructor&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PriorityCustomer</span><span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=n>PriorityCustomer</span><span class=o>::</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>PriorityCustomer</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logCall</span><span class=p>(</span><span class=s>&#34;PriorityCustomer copy assignment operator&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Customer</span><span class=o>::</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=n>rhs</span><span class=p>);</span>  <span class=c1>// assign base class parts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>priority</span> <span class=o>=</span> <span class=n>rhs</span><span class=p>.</span><span class=n>priority</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote class=warning-callout><p>Warning</p><p>The two copy functions will have similar code but do not call one from
the other as it is a non-sensical operation. If you really must, have the
two call a third private function such as init().</p></blockquote><blockquote class=summary-callout><p>Summary</p><ul><li>Make sure copy functions copy all of an object&rsquo;s data members
including the base class parts.</li><li>Don&rsquo;t implement one copy function in terms of the other. Put common
code in a third function.</li></ul></blockquote><a href=#ch3-resource-management><h2 id=ch3-resource-management><span class=hanchor arialabel=Anchor># </span>Ch3: Resource management</h2></a><a href=#item-13-use-objects-to-manage-resources><h3 id=item-13-use-objects-to-manage-resources><span class=hanchor arialabel=Anchor># </span><strong>Item 13:</strong> Use objects to manage resources</h3></a><p>Managing resources manually is very error prone and should be avoided.
Consider the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Investment</span> <span class=o>*</span> <span class=n>pInv</span> <span class=o>=</span> <span class=n>createInvestment</span><span class=p>();</span> <span class=c1>// factory function
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>...</span>                                     <span class=c1>// use pInv
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=n>pInv</span><span class=p>;</span>                            <span class=c1>// release object
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This may look reasonable but there are many ways it could fail to delete
<code>pInv</code>. if there is a pre-mature return within the function, control would
never reach the delete. Another situation is if <code>createInvestment()</code> and
<code>delete pInv</code> were in a loop that then breaks early. When this happens,
there will be a leak which will also affect any other resources helf by
<em>that</em> object.</p><p>Technically, carefull programming an avoid this issues, but this is not
realistic. As the code is maintained, someone may add a pre-mature return
without realising the consequences. Or someone may add an exception in a
function that did not use exceptions which will then cause a leak.</p><p>To avoid all of this, we can put resources into a resource managing object
which will then free the resources automatically when the destructor is
called.</p><p>The STL has smart pointers that are tailormade for resources that are
dynamically allocated on the heap and are used only within a single
block or function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Investment</span><span class=o>&gt;</span> <span class=n>pInv</span><span class=p>(</span><span class=n>createInvestment</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This example demonstrates two critical aspects of using objects to manage
resources:</p><ul><li>==<strong>Resources are acquired and immediately turned over to
resource-managing objects.</strong>== The idea that resources are acquired and
immediately turned over to a resource managing object is referred to as
<em>Resource Acquisition is Initialization</em>(RAII).</li><li>==<strong>Resource-managing objects use their destructors to ensure that
resources are released.</strong>== Destructors are automatically called when an object
goes out of scope so resources are released regardless of how control
leaves a block.</li></ul><blockquote class=abstract-callout><p>Summary</p><ul><li>To prevent leaks, use RAII objects that acquire objects in their
constructor and delete them in their destructor</li><li>Two most common RAII classes are std::unique_ptr and
std::shared_ptr</li></ul></blockquote><a href=#item-14-think-carefully-about-copying-behaviour-in-resource-managing-classes><h3 id=item-14-think-carefully-about-copying-behaviour-in-resource-managing-classes><span class=hanchor arialabel=Anchor># </span><strong>Item 14:</strong> Think carefully about copying behaviour in resource-managing classes</h3></a><p>Not all resources are heap based. For these resources, unique_ptr and
shared_ptr are generally inappropriate as resource handlers.</p><p>For example, if you create a RAII class called <code>Lock</code> that unlocks a mutex
in it&rsquo;s destructor so you never forget to unlock a mutex. What should
happen if this object is copied?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Lock</span> <span class=nf>ml1</span><span class=p>(</span><span class=o>&amp;</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Lock</span> <span class=nf>ml2</span><span class=p>(</span><span class=n>ml1</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>There are a few valid options:</p><ul><li><strong>Prohibit copying:</strong> In many cases it makes no sense to copy a RAII object.
In these situations you should just prohibit it (item 6). This is likely to be
true for an object such as <code>Lock</code>.</li><li><strong>Reference-count the underlying resource:</strong> Sometimes you may want to
hold on to a resource until there are no more objects using it. In this
situation a copy means that the count of objects referring to the resource
is incremented. A shared_ptr should be used to implement this behaviour.
shared_ptr also allows using a custom &ldquo;deleter&rdquo; where you can specify
a different behaviour (such as unlocking a mutex) instead when the
reference count goes to 0.</li><li><strong>Copy the underlying resource:</strong> Sometimes you can have as many copies
as you want of a resource. The only reason to have a resource-managing
class would be to ensure resources are released. In this case, copying the
RAII object should also mean copying the resource it wraps. An example
would be std::string.</li><li><strong>Transfer ownership of the underlying resource:</strong> In rare situations, you
may want to ensure that only one RAII object refers to a resource. Here
you will want to make sure that a copy means that ownership is
transferred.</li></ul><p>Remember that copying function will be generated by the compiler so you
will need to need to write the custom behaviour yourself.</p><blockquote class=abstract-callout><p>Summary</p><ul><li>Copying an RAII object entails copying the resource it manages. The
correct behaviour of the RAII object depends on the copying behaviour
of the underlying resource.</li><li>Common RAII class copying behaviours are: disallowing copy and
reference counting. However, there are others.</li></ul></blockquote><a href=#item-15-provide-access-to-raw-resources-in-resource-managing-classes><h3 id=item-15-provide-access-to-raw-resources-in-resource-managing-classes><span class=hanchor arialabel=Anchor># </span><strong>Item 15:</strong> Provide access to raw resources in resource-managing classes</h3></a><p>Resource-managing classes are great but they can&rsquo;t always be fully relied
on. Many APIs refer to the resources directly so from time to time you will
need to deal with raw resources.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>daysHeld</span><span class=p>(</span><span class=k>const</span> <span class=n>Investment</span><span class=o>*</span> <span class=n>pi</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>There are two ways to convert a RAII object to the resource it contains:
explicit conversion and implicit conversion.</p><p>Smart pointers contain a <code>get</code> member function that performs an explicit
conversion i.e. returns a copy of the raw pointer inside the smart pointer
object.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>days</span> <span class=o>=</span> <span class=n>daysHeld</span><span class=p>(</span><span class=n>pInv</span><span class=p>.</span><span class=n>get</span><span class=p>());</span>
</span></span></code></pre></td></tr></table></div></div><p>As for implicit conversion, it is a bit more dangerous but can sometimes
still be the correct choice. Here is an example of a Font class that
manages an underlying FontHandle resource with an implicit conversion
function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Font</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=k>operator</span> <span class=n>FontHandle</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>f</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>FontHandle</span> <span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// explicit conversion used to call changeFontSize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>changeFontSize</span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>get</span><span class=p>(),</span> <span class=n>newFontSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// implicit conversion version of same code
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>changeFontSize</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>newFontSize</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>However, now a client might accidentally create a FontHandle when a font
was intended.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Font</span> <span class=nf>f1</span><span class=p>(</span><span class=n>getFont</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>FontHandle</span> <span class=n>f2</span> <span class=o>=</span> <span class=n>f1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// meant to copy a font object but implicityly converted f1
</span></span></span><span class=line><span class=cl><span class=c1>// into its underlying FontHandle and then copied that
</span></span></span></code></pre></td></tr></table></div></div><p>Now the same FontHandle is being used in f1 and f2 which will then result
in a dangling pointer.</p><blockquote class=abstract-callout><p>Summary</p><ul><li>APIs often require access to raw resources so RAII classes should
offer a way to access the resource it manages.</li><li>Access may be explicit or implicit. Explicit is safer but implicit is
more convenient.</li></ul></blockquote><a href=#item-16-use-the-same-form-in-corresponding-uses-of-new-and-delete><h3 id=item-16-use-the-same-form-in-corresponding-uses-of-new-and-delete><span class=hanchor arialabel=Anchor># </span><strong>Item 16:</strong> Use the same form in corresponding uses of <code>new</code> and <code>delete</code></h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=o>*</span><span class=n>stringArray</span> <span class=o>=</span> <span class=k>new</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>delete</span> <span class=n>stringArray</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>The above code is wrong as you are constructing an array of objects but
deleting only 1 object. <code>new</code> allocates only enough space for an object and
then constructs that object if its a single object. For an array, it also
includes the memory required to store information on the size of the array.
Therefore, when you delete an array, you need to access the information.
This can only be done if you tell the compiler that the information is there
by using <code>delete []</code>.</p><blockquote class=warning-callout><p>Warning</p><ul><li>Make sure to use same for of <code>new</code> in all of your constructors so you
know which form to call in the destructor.</li><li>Abstain from using array types in <code>typedefs</code> so there is no confusion
on which form of <code>delete</code> to call when using a typedef.</li></ul></blockquote><blockquote class=abstract-callout><p>Summary</p><ul><li>Match the forms of <code>new</code> and <code>delete</code>. <code>new</code> requires a corresponding
<code>delete</code> and <code>new []</code> would require a corresponding <code>delete []</code>.</li></ul></blockquote><a href=#item-17-store-newed-objects-in-smart-pointers-in-standalone-statements><h3 id=item-17-store-newed-objects-in-smart-pointers-in-standalone-statements><span class=hanchor arialabel=Anchor># </span><strong>Item 17:</strong> Store newed objects in smart pointers in standalone statements</h3></a><p>Consider a situation where we have a function that returns a priority and
a function that processes a dynamically allocated Widget.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>priority</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>processWidget</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Widget</span><span class=o>&gt;</span> <span class=n>pw</span><span class=p>,</span> <span class=kt>int</span> <span class=n>priority</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Now consider the following way to call processWidget.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>processWidget</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>shared_Ptr</span><span class=o>&lt;</span><span class=n>Widget</span><span class=o>&gt;</span><span class=p>(</span><span class=k>new</span> <span class=n>Widget</span><span class=p>),</span> <span class=n>priority</span><span class=p>());</span>
</span></span></code></pre></td></tr></table></div></div><p>Three things need to happen:</p><ul><li>Call priority()</li><li>Execute &rsquo;new Widget&rsquo;</li><li>Call the shared_ptr constructor</li></ul><p>Compilers have leeway over which order these things are done. The order
they are done could be:</p><ul><li>Execute &rsquo;new Widget'</li><li>Call priority()</li><li>Call shared_ptr constructor</li></ul><p>The problem can now be seen. If there is an exception when priority() is
called, the pointer returned from &rsquo;new Widget&rsquo; will be lost and not stored
in the shared_ptr we used to guard against leaks.</p><p>To prevent this, use a separate statement to create and store the Widget
resource.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Widget</span><span class=o>&gt;</span> <span class=n>pw</span><span class=p>(</span><span class=k>new</span> <span class=n>Widget</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>processWidget</span><span class=p>(</span><span class=n>pw</span><span class=p>,</span> <span class=n>priority</span><span class=p>());</span>
</span></span></code></pre></td></tr></table></div></div><p>The revised code has less leeway to reorder the various components that
made the previous 1 line version of these two statements.</p><blockquote class=summary-callout><p>Summary</p><ul><li>Store newed objects in smart pointers in standalone statements.
Not doing so can lead to subtle resource leaks if exceptions are thrown.</li></ul></blockquote><a href=#ch4-designs-and-declarations><h2 id=ch4-designs-and-declarations><span class=hanchor arialabel=Anchor># </span>Ch4: Designs and declarations</h2></a><a href=#item-18-make-interfaces-easy-to-use-correctly-and-hard-to-use-incorrectly><h3 id=item-18-make-interfaces-easy-to-use-correctly-and-hard-to-use-incorrectly><span class=hanchor arialabel=Anchor># </span><strong>Item 18:</strong> Make interfaces easy to use correctly and hard to use incorrectly.</h3></a><p>If clients use your code incorrectly, <mark>your interface is partially to blame</mark>.
Consider the design below for a Date class:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Date</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Date</span> <span class=p>(</span><span class=kt>int</span> <span class=n>month</span><span class=p>,</span> <span class=kt>int</span> <span class=n>day</span><span class=p>,</span> <span class=kt>int</span> <span class=n>year</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>Two errors can easily happen:</p><ul><li>Client passes in day value into month. <code>Date d(30, 3, 1995);</code></li><li>Client passes in invalid value for month or date. <code>Date d(3, 40, 1995);</code></li></ul><p>Many similar client errors can be fixed by using simple wrapper with
explicit constructors.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Day</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>explicit</span> <span class=nf>Day</span><span class=p>(</span><span class=kt>int</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=n>val</span><span class=p>(</span><span class=n>d</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>Date</span><span class=o>::</span><span class=n>Date</span><span class=p>(</span><span class=k>const</span> <span class=n>Month</span><span class=o>&amp;</span> <span class=n>m</span><span class=p>,</span> <span class=k>const</span> <span class=n>Day</span><span class=o>&amp;</span> <span class=n>d</span><span class=p>,</span> <span class=k>const</span> <span class=n>Year</span><span class=o>&amp;</span> <span class=n>y</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Full fledged classes for day, month and year would be even better but
even structs are enough to show that introducing types can prevent a
interface usage errors.</p><p>Once the right types are being used, you can then progress to limiting the
values of those types if it is reasonable to do so. Enums can be used to do
this but they are not as typesafe as we would like as they can be used like
ints.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Month</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=n>Month</span> <span class=nf>Jan</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=n>Month</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=n>Month</span> <span class=nf>Feb</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=n>Month</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>Date</span> <span class=nf>d</span><span class=p>(</span><span class=n>Month</span><span class=o>::</span><span class=n>Mar</span><span class=p>(),</span> <span class=n>Day</span><span class=p>(</span><span class=mi>30</span><span class=p>),</span> <span class=n>Year</span><span class=p>(</span><span class=mi>1995</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><blockquote class=tip-callout><p>Hint</p><p>This item was probably written before scoped enums (enum classes)
were available. Now you probably could replace this with enum classes.</p></blockquote><p><em>Another way to prevent client errors is to add const.</em> For example you
can const qualify operator* which can prevent this error<br><code>if (a * b = c)...</code><br>This is an assignment when it should have been a comparison.</p><p><em>Try to make your interfaces behave consistently as possible.</em> Consistency
is one of the most important characteristic to making easy to use
interfaces. Conversely, inconsistency leads to aggravating interfaces</p><p><em>Any interface that relies on the client to remember to do something is
prone to incorrect use, because clients cant forget to do it.</em> An example
is returning raw pointers.</p><a href=#item-19-treat-class-design-as-type-design><h3 id=item-19-treat-class-design-as-type-design><span class=hanchor arialabel=Anchor># </span><strong>Item 19:</strong> Treat class design as type design.</h3></a><a href=#item-20-prefer-pass-by-reference-to-const-to-pass-by-value><h3 id=item-20-prefer-pass-by-reference-to-const-to-pass-by-value><span class=hanchor arialabel=Anchor># </span><strong>Item 20:</strong> Prefer pass-by-reference-to-const to pass-by-value.</h3></a><a href=#item-21-dont-try-to-return-a-reference-when-you-must-return-an-object><h3 id=item-21-dont-try-to-return-a-reference-when-you-must-return-an-object><span class=hanchor arialabel=Anchor># </span><strong>Item 21:</strong> Don&rsquo;t try to return a reference when you must return an object.</h3></a><a href=#item-22-declare-data-members-private><h3 id=item-22-declare-data-members-private><span class=hanchor arialabel=Anchor># </span><strong>Item 22:</strong> Declare data members private.</h3></a><a href=#item-23-prefer-non-member-non-friend-functions-to-member-functions><h3 id=item-23-prefer-non-member-non-friend-functions-to-member-functions><span class=hanchor arialabel=Anchor># </span><strong>Item 23:</strong> Prefer non-member non-friend functions to member functions.</h3></a><a href=#item-24-declare-non-member-functions-when-type-conversions-should-apply-to-all-parameters><h3 id=item-24-declare-non-member-functions-when-type-conversions-should-apply-to-all-parameters><span class=hanchor arialabel=Anchor># </span><strong>Item 24:</strong> Declare non-member functions when type conversions should apply to all parameters.</h3></a><a href=#item-25-consider-support-for-a-non-throwing-swap><h3 id=item-25-consider-support-for-a-non-throwing-swap><span class=hanchor arialabel=Anchor># </span><strong>Item 25:</strong> Consider support for a non-throwing swap.</h3></a><a href=#ch5-implementations><h2 id=ch5-implementations><span class=hanchor arialabel=Anchor># </span>Ch5: Implementations</h2></a><a href=#ch6-inheritance-and-object-oriented-design><h2 id=ch6-inheritance-and-object-oriented-design><span class=hanchor arialabel=Anchor># </span>Ch6: Inheritance and Object-Oriented Design</h2></a><a href=#ch7-templates-and-generic-programming><h2 id=ch7-templates-and-generic-programming><span class=hanchor arialabel=Anchor># </span>Ch7: Templates and generic programming</h2></a><a href=#ch8-customising-new-and-delete><h2 id=ch8-customising-new-and-delete><span class=hanchor arialabel=Anchor># </span>Ch8: Customising <code>new</code> and <code>delete</code></h2></a><a href=#ch9-miscellany><h2 id=ch9-miscellany><span class=hanchor arialabel=Anchor># </span>Ch9: Miscellany</h2></a></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://diwashrai.github.io/digital-garden/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Diwash Rai using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://diwashrai.github.io/digital-garden/>Home</a></li><li><a href=https://github.com/DiwashRai>GitHub</a></li></ul></footer></div></div></body></html>